---
title: "Plot ASR pheontypic results"
author: Bin He
date: "2023-1-1 (updated `r Sys.Date()`)"
output:
  html_notebook:
    theme: cerulean
    toc: true
    toc_float: true
    toc_depth: 4
    code_folding: hide
---

```{r setup, message=FALSE}
require(tidyverse)
require(cowplot)
```

## Introduction
### Goal

Plotting ASR data for Fig. 1, S1, ...

### Data
Jinye's table goes here

Read in data
```{r}
tmp <- read_tsv("../input/20220726-ASR-CFU-raw.tsv", col_types = cols(), comment = "#")
raw <- read_csv("../input/20221224-ASR-CFU-raw.csv", col_types = cols(), comment = "#") %>% 
  mutate(Date = gsub("d(\\d\\d)(\\d\\d)(\\d\\d)", "\\1/\\2/\\3", Date)) %>% 
  select(-`MO/MM`, -`PO/PM`) %>% 
  bind_rows(add_column(tmp, Experimenter = "JL"))

# data sanity check, quick view
sapply(select(raw, Species, Strain, Genotype), unique)
```

## Basal H2O2 resistance (S1A)
_**Goal**_

- Compare the basal survival rates of the two species at different [H2O2] to identify comparable concentrations for ASR.

_**Experiment**_

- Jinye measured CFU for _S. cerevisiae_ and _C. glabrata_ exposed to a range of [H2O2]

_**Data**_

- Filter the data for the relevant experiments.

**Main dataset**: 

Species         H2O2                        Description
--------------  -------------               ---------------
C. glabrata     0, 20, 40, 60, 80, 100 mM   Only M and O, no primary stress
S. cerevisiae   0, 2, 4, 6, 8, 10 mM        Only M and O, no primary stress

Date       Species   Replicate
--------   --------  ----------
03/21/22   Sc, Cg    1
03/22/22   Sc, Cg    2
03/24/22   Sc, Cg    3
03/28/22   Sc, Cg    4
04/01/22   Sc, Cg    5

_**Plotting**_

```{r}
use.s1 <- paste0(c("03/21", "03/22", "03/24", "03/28", "04/01"), "/22")
dat.Basal <- raw %>% select(-Experimenter, -Len_1, -Len_2, -Genotype) %>% 
  mutate(scaled = Count * Dilutions * 1e-3) %>% 
  filter(Date %in% use.s1) %>% 
  group_by(Date, Strain) %>% 
  mutate(r = num(scaled / scaled[Group == "M"], digits = 3))
dat.Basal
```

```{r}
# expand the species names
species.label <- c(
  "Sc" = "S. cerevisiae",
  "Cg" = "C. glabrata"
)

p <- dat.Basal %>% 
  mutate(H2O2 = gsub(" mM", "", H2O2),
         H2O2 = fct_reorder(H2O2, as.numeric(H2O2))) %>% 
  filter(H2O2 != "0") %>% 
  ggplot(aes(x = H2O2, y = r)) +
  geom_point(aes(shape = Date)) + 
  #geom_line(aes(group = Date, color = Date), alpha = 0.8) +
  scale_color_brewer(palette = "Dark2") +
  scale_shape_manual(values = 1:5, guide = "none") +
  stat_summary(fun.data = "mean_cl_boot", geom = "pointrange", color = "red2",
               size = 0.8, position = position_nudge(x = 0.3)) +
  facet_wrap(~Species, scales = "free_x", labeller = as_labeller(species.label)) +
  xlab(bquote(H[2]*O[2]~(mM))) + ylab("Basal survial rate (r)") +
  theme_cowplot(line_size = 0.7) +
  theme(strip.text = element_text(size = rel(1), face = 3))
p
ggsave("../output/20230101-basal-survival-across-h2o2-range-sc-cg.png", width = 5, height = 3)
```

Statistical test for difference between species at the highest concentration
```{r}
tmp <- dat.Basal %>% 
  filter(H2O2 %in% c("100 mM", "10 mM"))
tmp %>% group_by(Species) %>% summarize(mean = mean(r))

wilcox.test(r ~ Species, data = tmp, paired = TRUE)
```

## ASR at different H2O2 (S1B)
_**Goal**_

- Generalize the main figure finding of a stronger ASR in _C. glabrata_ than in _S. cerevisiae_ at a single primary stress treatment length by extending the analysis to multiple length of primary treatment

_**Data**_

**Main dataset**: 

Species       H2O2                       Description 
--------      -----                      ------------
C. glabrata   0, 20, 40, 60, 80, 100 mM  full ASR experiment
S. cerevisiae 0, 2, 4, 6, 8, 10mM        full ASR experiment

Date       Species   Strain    Replicate
-----      --------  -------   ----------
07/16/22   Cg        yH001,2    a1
07/17/22   Cg        yH001,2    a2
07/18/22   Cg        yH001,2    a3
07/29/22   Cg        yH001      b1
07/29/22   Sc        yH154      b1
08/01/22   Cg        yH001      b2
08/01/22   Sc        yH154      b2
08/02/22   Cg        yH001      b3
08/02/22   Sc        yH154      b3
08/04/22   Cg        yH001      b4
08/04/22   Sc        yH154      b4
08/11/22   Cg        yH001      b5
08/11/22   Sc        yH154      b5

_**Plotting**_

```{r}
use.s2 <- paste0(c("07/16", "07/17", "07/18", "07/29", "08/01", "08/02", "08/04", "08/11"), "/22")
dat.S2 <-  raw %>%
  separate(Group, into = c("Primary", "Secondary"), sep = 1) %>% 
  mutate(
    # arbitrarily decide any CFU counts < 3 are not included due to high CV
    Count = ifelse(Count < 3, NA, Count),
    scaled = Count * Dilutions * 1e-3
  ) %>% 
  filter(Date %in% use.s2) %>% 
  group_by(Date, Strain, Primary) %>% 
  # calculate r and r'
  mutate(r = num(scaled / scaled[Secondary == "M"], digits = 3)) %>% 
  # remove the secondary mock as the information are all used
  filter(Secondary != "M") %>%
  pivot_wider(id_cols = c(Date, Strain, Species, H2O2), 
              names_from = Primary, values_from = r, names_prefix = "r") %>% 
  mutate(ASR_score = rP / rM)
  
dat.S2
```

```{r}
p <- dat.S2 %>% 
  filter(!is.na(ASR_score)) %>% 
  mutate(H2O2 = gsub(" ?mM", "", H2O2),
         H2O2 = fct_reorder(H2O2, as.numeric(H2O2))) %>% 
  filter(H2O2 != "0") %>% 
  ggplot(aes(x = H2O2, y = ASR_score)) +
  geom_point(position = position_jitter(width = 0.1), alpha = 0.8) + 
  stat_summary(fun.data = "mean_cl_boot", geom = "pointrange", color = "red",
               size = 0.8, position = position_nudge(x = 0.2)) +
  #scale_y_log10() +
  facet_wrap(~Species, scales = "free_x", labeller = as_labeller(species.label)) +
  xlab(bquote(H[2]*O[2]~(mM))) + ylab("ASR score (r'/r)") +
  theme_cowplot(line_size = 0.7) +
  theme(strip.text = element_text(size = rel(1), face = 3))
p
ggsave("../output/20230102-ASR-score-across-h2o2-range-sc-cg.png", width = 5, height = 3)
```

## ASR at different primary stress duration (S2)
_**Goal**_

- Generalize the main figure finding of a stronger ASR in _C. glabrata_ than in _S. cerevisiae_ at a single [H~2~O~2~] by extending the analysis to multiple concentrations

_**Data**_

**Main dataset**: 

Species       Len_noPi          H2O2        Description 
--------      ---------         ------      ------------
C. glabrata   45, 90, 135 min   100 mM      full ASR experiment
S. cerevisiae 45, 90, 135 min   10mM        full ASR experiment

Date       Species   Len_noPi    Strain 
-----      --------  ---------   -------
06/06/33   Cg        45 min      yH001
06/06/22   Sc        45 min      yH154
06/06/33   Cg        90 min      yH001
06/06/22   Sc        90 min      yH154
06/06/33   Cg        135 min     yH001
06/06/22   Sc        135 min     yH154

**Supporting dataset**: 

Date       Species   Len_noPi    Strain 
-----      --------  ---------   -------
05/30/22   Cg        45 min      yH001  
05/30/22   Sc        45 min      yH154
06/01/33   Cg        45 min      yH001
06/01/22   Sc        45 min      yH154
06/04/33   Cg        45 min      yH001
06/04/22   Sc        45 min      yH154

_**Plotting**_

```{r}
use.s3 <- paste0(c("06/06", "06/04", "06/01", "05/30"), "/20")
tmp <-  raw %>%
  filter(Date %in% use.s3) %>% 
  mutate(
    # arbitrarily decide any CFU counts < 3 are not included due to high CV
    # not in use here. instead, label them in the plot (see below)
    # count = ifelse(Count < 3, NA, Count),
    scaled = Count * Dilutions * 1e-2
  ) %>% 
  # remove uninformative columns. only one H2O2 conc used for each species
  select(-Strain, -Genotype, -H2O2, -Len_2, -Experimenter)
```
  
Assume the triplicates were paired in the order they appear in the table, i.e., the first row in the MO, MM, PO, PM groups belong to the same biological replicate, we can derive three ASR_scores for each date x species x Len_1
```{r}
dat.S3 <- tmp %>% 
  group_by(Date, Species, Len_1, Group) %>%
  mutate(Repl = row_number()) %>% 
  pivot_wider(id_cols = c(Date, Species, Len_1, Repl),
              names_from = Group, values_from = scaled, names_sep = "") %>% 
  mutate(
    r = MO/MM, 
    rp = PO/PM, 
    ASR_score = rp/r,
    low_count = MO < 1 # mark experiments with < 3 counts
  )
dat.S3
```
```{r}
p <- dat.S3 %>% 
  #filter(!is.na(ASR_score)) %>% 
  mutate(len_1 = factor(gsub(" ?min", "", Len_1), levels = c("45", "90", "135"))) %>% 
  ggplot(aes(x = len_1, y = ASR_score)) +
  geom_hline(yintercept = 1, linetype = 2, color = "gray50") +
  geom_point(position = position_jitter(width = 0.1), size = 2) + 
  stat_summary(position = position_nudge(x = 0.2),
               fun.data = "mean_cl_boot", geom = "pointrange", color = "red") +
  xlab("Length of primary stress (min)") + ylab("ASR score (r'/r)") +
  facet_wrap(~Species, scales = "free_x", labeller = as_labeller(species.label)) +
  theme_cowplot(line_size = 0.7) +
  theme(legend.text = element_text(size = rel(1), face = 3),
        legend.position = c(0.1, 0.85),
        strip.text = element_text(size = rel(1), face = 3))
p
ggsave("../output/20230103-ASR-score-across-noPi-length-sc-cg.png", width = 5, height = 3)
```


```{r}
p <- dat.S3 %>% 
  #filter(!is.na(ASR_score)) %>% 
  mutate(len_1 = factor(Len_1, levels = c("45 min", "90 min", "135 min"))) %>% 
  ggplot(aes(x = Species, y = ASR_score)) +
  geom_point(#aes(fill = low_count),
    position = position_jitter(0.1), size = 1.5, shape = 21) + 
  stat_summary(
               fun.data = "mean_se", geom = "pointrange", color = "red") +
  #scale_y_log10() +
  scale_shape_manual(values = c(21,22), labels = species.label) +
  #scale_fill_manual(values = c("white", "gray40"), guide = "none") +
  #facet_wrap(~Species, scales = "free_x", labeller = as_labeller(species.label)) +
  facet_wrap(~ len_1, scales = "free") +
  xlab("Length of primary stress (min)") + ylab("ASR score (r'/r)") +
  theme_cowplot(line_size = 0.7)
p
ggsave("../output/20230103-ASR-score-across-noPi-length-sep-panel.png", width = 6, height = 3)
```