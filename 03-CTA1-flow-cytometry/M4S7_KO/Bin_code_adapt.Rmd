---
title: "Bin_code_adpt"
author: "Jinye Liang"
date: "August 6, 2021"
output: html_document
---

```{r}
library(tidyverse)
library(ggplot2)
library(dplyr)
library(mgcv)
library(broom)
```



```{r, Import the Data into R}
files <- dir("gz_merge", pattern = "merge-*") # get the file names of the merged
files <- file.path("gz_merge", files)         # this appends the directory to the file names
#names(files) <- paste0("Rep", 1:3)        # name the replicates

names(files) <- c("Rep1-0Pi-Ctrl","Rep1-H2O2-Rep2-0Pi", "Rep2-H2O2-Rep3-0Pi", "Rep3-H2O2-Ctrl")

tp <- c("0min",  "30min", "60min", "90min", "120min", "150min",  "180min", "210min", "240min") # ordered time points

# import and process the data to the format we want
dat.ord <- files %>% 
  map(~read_csv(., na = c("", "NA", "N/A"), col_types = cols())) %>% 
  bind_rows(.id = "Replicate") %>% 
  filter(`X Parameter` == "BL1-H", is.na(`Y Parameter`)) %>% 
  select(Replicate, Plate, Group, Sample, Count, median = `X Median`, peak = `X Peak`,
         sd = `X SD`, cv = `X %CV`, rCV = `X %rCV`) %>% 
  mutate(Group = ordered(Group, levels = tp)) %>% 
  arrange(Group)

write_csv(dat.ord, file = "gz_merge/20210724-0805-Msn4Skn7-KO-flow-data.csv")
```


```{r, Subset the dataset and merge with the genotype information:}
# get genotype info
tr_files <- dir("treatment", pattern = "d0*")
tr_files <- file.path("treatment", tr_files)
names(tr_files) <- c("Rep1-0Pi-Ctrl","Rep1-H2O2-Rep2-0Pi", "Rep2-H2O2-Rep3-0Pi", "Rep3-H2O2-Ctrl")


treat.fil <- tr_files %>% 
  map(~read_csv(., na = c("","NA","N/A"), col_types = cols())) %>% 
  bind_rows(.id = "Replicate") %>% 
  filter(!is.na(`group_name`)) %>% 
  select(Replicate, genotype = `group_name`, Sample, treat)

# combine genotype and treat variables into the flow data
data <- left_join(dat.ord, treat.fil, by = c("Replicate", "Sample"))
#sum(is.na(data$Group))

write_csv(data, file = "gz_merge/20210724-0805-treat-gt-Msn4Skn7-KO-flow-data.csv.gz")

# select out 0Pi & h2o2 data
pi.dat <- data %>% 
  filter(treat == "0Pi") %>% 
  select(time = Group, Sample, Plate, replicate = Replicate, genotype, median) %>% 
  arrange(time, genotype, replicate)

h2o2.dat <- data %>% 
  filter(treat == "H2O2") %>% 
  select(time = Group, Sample, Plate, replicate = Replicate, genotype, median) %>% 
  arrange(time, genotype, replicate)

```

```{r, visualize the data}
pi.dat %>% subset(., !is.na(median)) %>% 
  ggplot(aes(x = time, y = median, color = replicate)) + geom_point(size = 0.2) + 
  facet_wrap(~genotype) + stat_summary(fun = "median", geom = "point", size = 2) +
  stat_smooth(aes(x = as.numeric(time)), se = FALSE) +
  theme_bw() +
  theme(axis.text.x=element_text(angle=45,hjust=1)) +
  ylab("CTA1-GFP expression (median)") +
  ggtitle("Treatment: Phosphate Starvation")

pi.dat %>% subset(., !is.na(median)) %>% 
  ggplot(aes(x = time, y = median, color = genotype)) + geom_point(size = 0.2) + 
  stat_summary(fun = "mean", geom = "point", size = 2) +
  stat_smooth(aes(x = as.numeric(time)), se = FALSE) +
  theme_bw() +
  theme(legend.position="right", legend.box = "vertical", legend.text = element_text(size=10), 
        axis.title = element_text(size = 12), 
        axis.text.x = element_text(angle=45,hjust=1), axis.text = element_text(size = 12), 
        plot.title = element_text(size = 14, hjust = 0)) +
  labs(y = "CTA1-GFP expression (MFI)", title = "A")

h2o2.dat %>% subset(., !is.na(median)) %>% 
  ggplot(aes(x = time, y = median, color = replicate)) + geom_point(size = 0.2) + 
  facet_wrap(~genotype) + stat_summary(fun = "median", geom = "point", size = 2) +
  stat_smooth(aes(x = as.numeric(time)), se = FALSE) +
  theme_bw() +
  theme(axis.text.x=element_text(angle=45,hjust=1)) +
  ylab("CTA1-GFP expression (median)") +
  ggtitle("Treatment: 2mM H2O2")

h2o2.dat %>% subset(., !is.na(median)) %>% 
  ggplot(aes(x = time, y = median, color = genotype)) + geom_point(size = 0.2) + 
  stat_summary(fun = "mean", geom = "point", size = 2) +
  stat_smooth(aes(x = as.numeric(time)), se = FALSE) +
  theme_bw() +
  theme(legend.position="right", legend.box = "vertical", legend.text = element_text(size=10), 
        axis.title = element_text(size = 12), 
        axis.text.x = element_text(angle=45,hjust=1), axis.text = element_text(size = 12), 
        plot.title = element_text(size = 14, hjust = 0)) + 
  labs(y = "CTA1-GFP expression (MFI)", title = "D")


# title = "The effects of oxidative stress on CTA1-GFP \nin different TFs KO strains"
# title = "The effects of Phosphate Starvation on CTA1-GFP \nin different TFs KO strains"

```
```{r, 2D plot - 0Pi & 2mM H2O2}
# extracting the maximum induction level for each genotype at each condition
## 0Pi

# each genotype to wt
pi.max <- subset(pi.dat, !is.na(median)) %>% 
   group_by(genotype) %>%                 
   summarise(maximum = max(median)) %>% 
  mutate(pi.max.Rtowt = maximum / (.$maximum[genotype == "wt"])) %>%  
  # maximum induction level of each genotype relative to wt
  rename(., pi.max = maximum)


## H2O2
h2o2.max <- subset(h2o2.dat, !is.na(median)) %>% 
  group_by(genotype) %>% 
  summarise(maximum = max(median)) %>% 
  mutate(h2o2.max.Rtowt = maximum / (.$maximum[genotype == "wt"])) %>% 
  rename(., h2o2.max = maximum)

## combine 0Pi and H2O2 max Rtowt
max.dat <- left_join(pi.max, h2o2.max, by = "genotype")
write.csv(max.dat, file = "output/M4S7-max-Rtowt.csv", row.names = FALSE)

# visualize the r-to-wt level for 2 conditions in a 2D scatter plot
max.dat %>% 
  ggplot(aes(x = pi.max.Rtowt, y = h2o2.max.Rtowt, color = genotype)) +
  geom_point(size = 2) +   
  theme_bw() +
  # change decimal scale to pct
  scale_y_continuous(labels = scales::percent) +
  scale_x_continuous(labels = scales::percent) +
  geom_abline(slope = 1, intercept = 0, color="orange", linetype="dashed", size=1) +
  xlab("Phosphate starvation") +
  ylab("Oxidative stress") +
  ggtitle("Maximum of the CTA1-GFP median induction level Relative to wt")
  

```

```{r, combine 2-4Imp and 6-8Imp Relative to wt Max induction}
# import Other TF Kos Rtowt data
max.m2m4 <- read.csv("../../M2M4_KO/M2M4_KO/output/M2M4-max-Rtowt.csv")
max.s7y1 <- read.csv("../../S7Y1_KO/S7Y1_KO/output/S7Y1-max-Rtowt.csv")


# rowbind two dataframe
max.dat.cb <- max.m2m4 %>% 
  bind_rows(., max.dat) %>% 
  bind_rows(max.s7y1) %>%
  group_by(genotype) %>% 
  summarise(pi.max = mean(pi.max), pi.max.Rtowt = mean(pi.max.Rtowt), h2o2.max = mean(h2o2.max), h2o2.max.Rtowt = mean(h2o2.max.Rtowt))
  



# visualize Rtowt in 0Pi and Os conditions

max.dat.cb %>% 
  ggplot(aes(x = pi.max.Rtowt, y = h2o2.max.Rtowt, color = genotype)) +
  geom_point(size = 3, alpha = 0.8) +   
  theme_bw() +
  # change decimal scale to pct
  scale_y_continuous(labels = scales::percent, breaks = seq(0, 1.2, 0.2)) +
  scale_x_continuous(labels = scales::percent, breaks = seq(0, 1.2, 0.2)) +
  scale_color_manual(values = c("grey", "deeppink3", "hotpink", "darkorchid2", "deepskyblue", "dodgerblue3", "grey20", "seagreen1"))  +
  # change the scale of x and y axis
  coord_fixed(ratio = 1, xlim = c(0,1.2), ylim = c(0,1.2), expand = TRUE, clip = "on") +
  geom_abline(slope = 1, intercept = 0, color="wheat2", linetype="dashed", size=1) +
  theme(legend.position="right", legend.box = "vertical", legend.text = element_text(size=10), axis.title = element_text(size = 14), axis.text = element_text(size = 12), title = element_text(size = 12)) + 
  labs(x = "Phosphate starvation", y = "Oxidative stress", title = "Maximum of the CTA1-GFP median induction level \nof the TF KOs relative to wt")

ggsave("max(MFI_mut_wt).tiff", path = "./output", width = 6, height = 6, device='tiff', dpi=700)

```
```{r}
# visualize Rtowt in 0Pi and Os conditions

max.dat.cb %>% 
  ggplot(aes(x = pi.max.Rtowt, y = h2o2.max.Rtowt, color = genotype)) +
  geom_point(size = 3, alpha = 0.8) +   
  theme_bw() +
  # change decimal scale to pct
  scale_y_continuous(labels = scales::percent, breaks = seq(0, 1.2, 0.2)) +
  scale_x_continuous(labels = scales::percent, breaks = seq(0, 1.2, 0.2)) +
  scale_color_manual(values = c("grey", "deeppink3", "hotpink", "darkorchid2", "deepskyblue", "dodgerblue3", "grey20", "seagreen1"))  +
  # change the scale of x and y axis
  coord_fixed(ratio = 1, xlim = c(0,1.2), ylim = c(0,1.2), expand = TRUE, clip = "on") +
  geom_abline(slope = 1, intercept = 0, color="wheat2", linetype="dashed", size=1) +
  theme(legend.position="right", legend.box = "vertical", legend.text = element_text(size=10), axis.title = element_text(size = 14), axis.text = element_text(size = 12), title = element_text(size = 12)) + 
  labs(x = "Phosphate starvation", y = "Oxidative stress", title = "G")

# title = title = "Maximum of the CTA1-GFP median induction level \nof the TF KOs relative to wt"

```



Data transformation
We want to transform the median fluorescent intensity into fold change relative to time point 0 for each genotype. Then we would like to normalize that for each non-wt genotype by the wild type fold change at each time point. The goal is to highlight the deficiency in gene induction in the knock out.


```{r, data transformation}
# first let's calculate the fold change by dividing the median fluorescent indensity of each genotype at each time point by the mean MFI for that genotype at time point 0.
# we begin by calculating the baseline for each genotype
pi.summary <- subset(pi.dat, !is.na(median)) %>% 
  group_by(genotype, time) %>% 
  summarize(baseline = mean(median)) %>% 
  filter(time == "0min") %>% 
  select(-time)
```

```{r}
# next we calculate the fold change
pi.dat1 <- pi.dat %>% 
  left_join(pi.summary, by = "genotype") %>% 
  mutate(fc = median / baseline)
# for each time point, we calculate the mean fold change for the wild type strain  
pi.wt.fc <- pi.dat1 %>% 
  filter(genotype == "wt") %>% 
  group_by(time) %>% 
  summarize(wt.mFC = mean(fc))
# finally, we normalize the non-wt strains by the wild type mean fold change at each time point
pi.dat1 <- pi.dat1 %>% 
  left_join(pi.wt.fc, by = "time") %>% 
  mutate(normFC = fc / wt.mFC)

```

plot the normalized fold changes
```{r, plot the normalized fold changes}
pi.dat1 %>% 
  ggplot(aes(x = time, y = normFC, color = genotype)) + geom_point(size = 0.2) + 
  stat_summary(fun = "mean", geom = "point", size = 2) +
  stat_smooth(aes(x = as.numeric(time)), se = FALSE) +
  ylab("fold change relative to 0 min, normalized to wild type") +
  theme_bw()

```
We could perform linear regression on the data to test if the slope is significantly different from zero. We use a “nest-map-unnest” workflow

```{r}
pi.dat1 %>% 
  filter(genotype != "wt") %>% 
  mutate(time = as.numeric(time)) %>% 
  group_by(genotype) %>% 
  nest() %>% 
  mutate(
    fit = map(data, ~ lm(normFC ~ time, data = .x)),
    tidied = map(fit, tidy)
  ) %>% 
  unnest(tidied)


```